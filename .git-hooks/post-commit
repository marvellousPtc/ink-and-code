#!/bin/bash

# Post-commit hook: æ£€æµ‹ [blog] æ ‡è®°ï¼Œè§¦å‘ Cursor ç”Ÿæˆåšå®¢

# è·å–æœ€æ–° commit ä¿¡æ¯
COMMIT_MSG=$(git log -1 --format="%s")
COMMIT_HASH=$(git log -1 --format="%H")
COMMIT_SHORT=$(git log -1 --format="%h")

# æ£€æŸ¥æ˜¯å¦åŒ…å« [blog] æ ‡è®°
if [[ "$COMMIT_MSG" != *"[blog]"* ]]; then
    exit 0
fi

echo ""
echo "=========================================="
echo "ğŸš€ æ£€æµ‹åˆ° [blog] æ ‡è®°ï¼Œå‡†å¤‡ç”Ÿæˆåšå®¢æ–‡ç« ..."
echo "=========================================="
echo "Commit: $COMMIT_SHORT"
echo "Message: $COMMIT_MSG"
echo ""

# æ„å»ºæç¤ºè¯
PROMPT="è¯·æ ¹æ®æˆ‘åˆšæ‰çš„ commit ($COMMIT_SHORT: $COMMIT_MSG) ç”Ÿæˆä¸€ç¯‡æŠ€æœ¯åšå®¢æ–‡ç« å¹¶å‘å¸ƒåˆ°æˆ‘çš„ç½‘ç«™ã€‚

è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. è¿è¡Œ git diff HEAD~1 HEAD æŸ¥çœ‹ä»£ç æ”¹åŠ¨
2. é˜…è¯»ç›¸å…³æ–‡ä»¶ï¼Œç†è§£æ”¹åŠ¨çš„ä¸Šä¸‹æ–‡å’Œç›®çš„
3. æ’°å†™ä¸€ç¯‡é«˜è´¨é‡çš„ä¸­æ–‡æŠ€æœ¯åšå®¢ï¼ˆ800-1500å­—ï¼‰
4. è°ƒç”¨ API å‘å¸ƒæ–‡ç« 

å‘å¸ƒ APIï¼š
curl -X POST \"\${INK_AND_CODE_URL}/api/article/create-from-commit\" \\
  -H \"Content-Type: application/json\" \\
  -H \"Authorization: Bearer \${INK_AND_CODE_TOKEN}\" \\
  -d '{\"title\": \"æ ‡é¢˜\", \"content\": \"Markdownå†…å®¹\", \"tags\": [\"æ ‡ç­¾\"], \"published\": false}'
"

# å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿ï¼ˆmacOSï¼‰
if command -v pbcopy &> /dev/null; then
    echo "$PROMPT" | pbcopy
    echo "âœ… æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"
fi

# æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥ï¼ˆmacOSï¼‰
if command -v osascript &> /dev/null; then
    osascript -e "display notification \"Commit: $COMMIT_SHORT\" with title \"ğŸ“ Blog Post Ready\" subtitle \"æç¤ºè¯å·²å¤åˆ¶ï¼Œè¯·åœ¨ Cursor ä¸­ç²˜è´´æ‰§è¡Œ\""
fi

# å°è¯•æ‰“å¼€/æ¿€æ´» Cursor
if command -v cursor &> /dev/null; then
    echo "ğŸ”„ æ­£åœ¨æ¿€æ´» Cursor..."
    cursor .
elif [[ -d "/Applications/Cursor.app" ]]; then
    open -a "Cursor" .
fi

echo ""
echo "ğŸ“‹ è¯·åœ¨ Cursor ä¸­ç²˜è´´æç¤ºè¯ (Cmd+V) å¹¶æ‰§è¡Œ"
echo "=========================================="
echo ""
