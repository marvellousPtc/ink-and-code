name: Auto Blog from Commit

on:
  push:
    branches:
      - main
      - master

jobs:
  generate-blog:
    # åªæœ‰ commit message åŒ…å« [blog] æ—¶æ‰è¿è¡Œ
    if: contains(github.event.head_commit.message, '[blog]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘2æ¬¡æäº¤ä»¥ä¾¿ diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get commit diff
        id: diff
        run: |
          # è·å–æœ¬æ¬¡ commit çš„ diff
          DIFF=$(git diff HEAD~1 HEAD --no-color 2>/dev/null || git show HEAD --no-color)
          
          # å°† diff ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¤„ç†å¤šè¡Œï¼‰
          echo "$DIFF" > /tmp/commit_diff.txt
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --format="" HEAD)
          echo "files_changed<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate blog post with AI
        id: generate
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # è¯»å– diff
          DIFF=$(cat /tmp/commit_diff.txt)
          
          # å‡†å¤‡ prompt
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          REPO="${{ github.repository }}"
          FILES_CHANGED="${{ steps.diff.outputs.files_changed }}"
          
          # åˆ›å»º AI è¯·æ±‚çš„ prompt
          PROMPT="ä½ æ˜¯ä¸€ä½æŠ€æœ¯åšå®¢ä½œå®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ Git commit ä¿¡æ¯ï¼Œæ’°å†™ä¸€ç¯‡æŠ€æœ¯åšå®¢æ–‡ç« ã€‚

## Commit ä¿¡æ¯
- ä»“åº“: ${REPO}
- Commit Message: ${COMMIT_MSG}
- å˜æ›´çš„æ–‡ä»¶:
${FILES_CHANGED}

## Commit Diff
\`\`\`
${DIFF:0:10000}
\`\`\`

## è¦æ±‚
1. æ–‡ç« æ ‡é¢˜è¦å¸å¼•äººï¼Œä½“ç°æŠ€æœ¯äº®ç‚¹
2. ç”¨ Markdown æ ¼å¼æ’°å†™
3. åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
   - èƒŒæ™¯/é—®é¢˜æè¿°
   - è§£å†³æ–¹æ¡ˆ/å®ç°ç»†èŠ‚
   - å…³é”®ä»£ç è¯´æ˜
   - æ€»ç»“å’Œæ”¶è·
4. ä»£ç å—ä½¿ç”¨æ­£ç¡®çš„è¯­è¨€æ ‡è®°
5. å­—æ•°æ§åˆ¶åœ¨ 800-1500 å­—
6. ä½¿ç”¨ä¸­æ–‡æ’°å†™

è¯·ç›´æ¥è¾“å‡ºæ–‡ç« å†…å®¹ï¼Œæ ¼å¼ä¸ºï¼š
---TITLE---
<æ–‡ç« æ ‡é¢˜>
---CONTENT---
<æ–‡ç« æ­£æ–‡ Markdown>
---TAGS---
<æ ‡ç­¾1>,<æ ‡ç­¾2>,<æ ‡ç­¾3>"

          # ä½¿ç”¨ DeepSeekï¼ˆä¼˜å…ˆï¼‰ã€Claude æˆ– OpenAI API
          # è½¬ä¹‰ JSON ç‰¹æ®Šå­—ç¬¦
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          if [ -n "$DEEPSEEK_API_KEY" ]; then
            echo "Using DeepSeek API..."
            
            RESPONSE=$(curl -s https://api.deepseek.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
              -d "{
                \"model\": \"deepseek-chat\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $ESCAPED_PROMPT
                }]
              }")
            
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
            
          elif [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Using Claude API..."
            
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{
                \"model\": \"claude-sonnet-4-20250514\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $ESCAPED_PROMPT
                }]
              }")
            
            # æå–ç”Ÿæˆçš„å†…å®¹
            GENERATED=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
            
          elif [ -n "$OPENAI_API_KEY" ]; then
            echo "Using OpenAI API..."
            
            RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"gpt-4o\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $ESCAPED_PROMPT
                }]
              }")
            
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          else
            echo "Error: No AI API key provided (need DEEPSEEK_API_KEY, ANTHROPIC_API_KEY, or OPENAI_API_KEY)"
            exit 1
          fi
          
          if [ -z "$GENERATED" ]; then
            echo "Error: AI generation failed"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          # ä¿å­˜ç”Ÿæˆçš„å†…å®¹
          echo "$GENERATED" > /tmp/generated_post.txt
          
          # è§£ææ ‡é¢˜ã€å†…å®¹ã€æ ‡ç­¾
          TITLE=$(echo "$GENERATED" | sed -n '/---TITLE---/,/---CONTENT---/p' | head -n -1 | tail -n +2 | tr -d '\n')
          CONTENT=$(echo "$GENERATED" | sed -n '/---CONTENT---/,/---TAGS---/p' | head -n -1 | tail -n +2)
          TAGS=$(echo "$GENERATED" | sed -n '/---TAGS---/,$p' | tail -n +2 | tr -d '\n')
          
          # è¾“å‡ºåˆ° GitHub Actions å˜é‡
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          
          # å¤šè¡Œå†…å®¹éœ€è¦ç‰¹æ®Šå¤„ç†
          {
            echo 'content<<CONTENT_EOF'
            echo "$CONTENT"
            echo 'CONTENT_EOF'
          } >> $GITHUB_OUTPUT
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Publish to blog
        env:
          INK_AND_CODE_TOKEN: ${{ secrets.INK_AND_CODE_TOKEN }}
          INK_AND_CODE_URL: ${{ secrets.INK_AND_CODE_URL }}
        run: |
          TITLE="${{ steps.generate.outputs.title }}"
          CONTENT="${{ steps.generate.outputs.content }}"
          TAGS="${{ steps.generate.outputs.tags }}"
          
          # å°† tags è½¬ä¸º JSON æ•°ç»„
          TAGS_JSON=$(echo "$TAGS" | tr ',' '\n' | jq -R . | jq -s .)
          
          # è½¬ä¹‰å†…å®¹
          ESCAPED_CONTENT=$(echo "$CONTENT" | jq -Rs .)
          ESCAPED_TITLE=$(echo "$TITLE" | jq -Rs . | sed 's/^"//;s/"$//')
          
          # å‘é€åˆ°åšå®¢ API
          RESPONSE=$(curl -s -X POST "${INK_AND_CODE_URL}/api/article/create-from-commit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $INK_AND_CODE_TOKEN" \
            -d "{
              \"title\": \"$ESCAPED_TITLE\",
              \"content\": $ESCAPED_CONTENT,
              \"tags\": $TAGS_JSON,
              \"published\": false,
              \"commitInfo\": {
                \"repo\": \"${{ github.repository }}\",
                \"sha\": \"${{ github.sha }}\",
                \"message\": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
                \"url\": \"${{ github.event.head_commit.url }}\"
              }
            }")
          
          echo "API Response: $RESPONSE"
          
          # æ£€æŸ¥å“åº”
          CODE=$(echo "$RESPONSE" | jq -r '.code // 500')
          if [ "$CODE" != "201" ]; then
            echo "Failed to publish blog post"
            echo "Error: $(echo "$RESPONSE" | jq -r '.message // "Unknown error"')"
            exit 1
          fi
          
          ARTICLE_URL=$(echo "$RESPONSE" | jq -r '.data.url // "N/A"')
          echo "âœ… Blog post created successfully!"
          echo "ğŸ“ Title: $TITLE"
          echo "ğŸ”— URL: $ARTICLE_URL"
